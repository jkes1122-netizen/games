<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>積動城市 SPARK - 數位裁判系統 v2.4</title>
    <style>
        :root { --p1-bg: #0d1b2a; --p1-accent: #00acee; --p2-bg: #2b0d0d; --p2-accent: #ff4444; --text-color: #e0e1dd; }
        body { background: #000; color: var(--text-color); font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 2px solid #333; }
        .turn-badge { font-size: 1.5rem; background: #f1c40f; color: #000; padding: 5px 20px; border-radius: 20px; font-weight: bold; }
        .battlefield { display: flex; flex: 1; gap: 10px; margin-top: 10px; overflow: hidden; }
        .side { flex: 1; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        #side-p1 { background: var(--p1-bg); border: 2px solid var(--p1-accent); }
        #side-p2 { background: var(--p2-bg); border: 2px solid var(--p2-accent); }
        .slot { background: rgba(255,255,255,0.05); border: 1px dashed #555; border-radius: 8px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transition: 0.3s; }
        .char-card { width: 100%; padding: 10px; box-sizing: border-box; }
        .char-name { font-weight: bold; font-size: 1.1em; color: #fff; }
        .status-tag { background: #e67e22; color: #fff; font-size: 0.7rem; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .hp-container { width: 100%; background: #333; height: 10px; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s; }
        .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .skill-btn { background: #444; color: #fff; border: 1px solid #666; padding: 5px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .skill-btn:hover:not(:disabled) { background: #666; }
        .skill-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .slot.acted { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        .slot.targetable { border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; cursor: crosshair; animation: pulse 0.8s infinite; }
        .slot.dead { filter: grayscale(1); opacity: 0.3; }
        .control-panel { height: 150px; display: flex; gap: 10px; margin-top: 10px; }
        .log-box { flex: 3; background: #111; border: 1px solid #333; padding: 10px; overflow-y: scroll; font-family: monospace; color: #0f0; font-size: 0.9rem; }
        .btn-group { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .main-btn { flex: 2; background: #f1c40f; color: #000; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .reset-btn { flex: 1; background: #c0392b; color: #fff; border: none; font-size: 0.9rem; cursor: pointer; border-radius: 5px; }
        .add-btn { background: transparent; color: #777; border: none; font-size: 2rem; cursor: pointer; }
        .add-interface { width: 90%; display: none; flex-direction: column; gap: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<header>
    <div><h2 style="margin:0;">SPARK 積動城市</h2><small>數位裁判台 v2.4 (全局技能限制)</small></div>
    <div style="text-align: right">
        <div class="turn-badge">第 <span id="turn-count">1</span> 回合</div>
        <div id="link-count-display" style="color: #ff4444; font-size: 0.9rem; margin-top: 5px;">「槍林彈雨」剩餘次數：2 / 2</div>
    </div>
</header>

<div class="battlefield">
    <div class="side" id="side-p1"><h3 style="margin:0; text-align:center; color:var(--p1-accent)">我方隊伍</h3></div>
    <div class="side" id="side-p2"><h3 style="margin:0; text-align:center; color:var(--p2-accent)">敵方隊伍</h3></div>
</div>

<div class="control-panel">
    <div class="log-box" id="combat-log">> 戰場初始化完成。</div>
    <div class="btn-group">
        <button class="main-btn" onclick="nextTurn()">結束回合<br>Next Turn</button>
        <button class="reset-btn" onclick="resetBattlefield()">清理對局 / 重置戰場</button>
    </div>
</div>

<datalist id="char-list-data"></datalist>

<script>
    // 1. 角色大數據庫 (在這裡加入你的新角色)
    const characterDatabase = [
        {
            id: "ranger", name: "英國遊騎兵", hp: 500, tag: "ranger",
            skills: [
                { name: "精準射擊", damage: 100, type: "true_dmg" },
                { name: "槍林彈雨", damage: 150, type: "ranger_link" },
                { name: "疾風步伐", damage: 0, type: "self_buff", effect: "dodge" }
            ]
        },
        {
            id: "guan_yu", name: "關羽", hp: 1200, tag: "general",
            skills: [
                { name: "青龍偃月", damage: 200, type: "physical" },
                { name: "武聖威嚴", damage: 0, type: "enemy_debuff", effect: "weak" }
            ]
        },
        { id: "wei_yan", name: "魏延", hp: 1000, tag: "general", skills: [{ name: "斬月閃", damage: 150, type: "physical" }] },
        { id: "soldier_a", name: "一般小兵", hp: 200, tag: "mob", skills: [{ name: "突刺", damage: 50, type: "physical" }] }
    ];

    let battlefield = { p1: [null, null, null, null, null], p2: [null, null, null, null, null] };
    let currentTurn = 1;
    let pendingAction = null;
    let globalRangerLinkLimit = 2; // 全局限制：整場只能用 2 次

    window.onload = function() { initDatalist(); renderBattlefield(); };

    function initDatalist() {
        const list = document.getElementById('char-list-data');
        characterDatabase.forEach(char => {
            const option = document.createElement('option');
            option.value = char.name;
            list.appendChild(option);
        });
    }

    function renderBattlefield() {
        renderSide('p1', document.getElementById('side-p1'));
        renderSide('p2', document.getElementById('side-p2'));
        document.getElementById('link-count-display').innerText = `「槍林彈雨」剩餘次數：${globalRangerLinkLimit} / 2`;
    }

    function renderSide(sideKey, container) {
        const title = container.querySelector('h3');
        container.innerHTML = ''; container.appendChild(title);
        battlefield[sideKey].forEach((char, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = `slot`;
            slotDiv.dataset.side = sideKey; slotDiv.dataset.index = index;
            if (!char) {
                slotDiv.innerHTML = `<button class="add-btn" onclick="toggleAddMenu('${sideKey}', ${index})">+</button><div class="add-interface" id="add-menu-${sideKey}-${index}"><input list="char-list-data" placeholder="搜尋角色..." id="input-${sideKey}-${index}"><button onclick="addCharacter('${sideKey}', ${index})">加入</button></div>`;
            } else {
                if (char.hp <= 0) slotDiv.classList.add('dead');
                if (char.acted) slotDiv.classList.add('acted');
                const hpPercent = (char.hp / char.maxHp) * 100;
                let statusHtml = char.statuses.map(s => `<span class="status-tag">${s === 'weak' ? '虛弱' : s}</span>`).join('');
                let skillsHtml = char.skills.map((s, sIdx) => {
                    const isDisabled = (s.type === 'ranger_link' && globalRangerLinkLimit <= 0) ? 'disabled' : '';
                    return `<button class="skill-btn" ${isDisabled} onclick="selectSkill('${sideKey}', ${index}, ${sIdx})">${s.name}</button>`;
                }).join('');

                slotDiv.innerHTML = `<div class="char-card"><div class="char-header"><span class="char-name">${char.name}${statusHtml}</span><small onclick="removeChar('${sideKey}', ${index})" style="cursor:pointer">❌</small></div><div class="hp-container"><div class="hp-fill" style="width: ${hpPercent}%"></div></div><small>HP: ${char.hp}/${char.maxHp}</small><div class="skill-list">${skillsHtml}</div></div>`;
                slotDiv.onclick = function(e) { if(e.target.tagName !== 'BUTTON' && pendingAction && slotDiv.classList.contains('targetable')) resolveAttack(sideKey, index); }
            }
            container.appendChild(slotDiv);
        });
    }

    function toggleAddMenu(side, index) { document.getElementById(`add-menu-${side}-${index}`).style.display = 'flex'; }
    function addCharacter(side, index) {
        const inputVal = document.getElementById(`input-${side}-${index}`).value;
        const template = characterDatabase.find(c => c.name === inputVal);
        if (!template) return;
        battlefield[side][index] = JSON.parse(JSON.stringify(template));
        battlefield[side][index].maxHp = template.hp; battlefield[side][index].acted = false; battlefield[side][index].statuses = [];
        renderBattlefield();
    }
    function removeChar(side, index) { battlefield[side][index] = null; renderBattlefield(); }

    function selectSkill(side, index, skillIndex) {
        const actor = battlefield[side][index];
        const skill = actor.skills[skillIndex];
        if (actor.hp <= 0 || actor.acted) return;

        if (skill.type === "ranger_link" && globalRangerLinkLimit <= 0) {
            addLog(`❌ 此局聯動次數已用盡！`); return;
        }

        if (skill.type === 'self_buff') {
            actor.statuses.push(skill.effect); actor.acted = true;
            addLog(`[技能] ${actor.name} 使用了 【${skill.name}】！`); renderBattlefield(); return;
        }

        pendingAction = { side, index, skill, actorName: actor.name };
        addLog(`[準備] ${actor.name} ${skill.name}，請選目標。`);
        highlightTargets(side === 'p1' ? 'p2' : 'p1');
    }

    function highlightTargets(targetSide) {
        document.querySelectorAll(`.slot[data-side="${targetSide}"]`).forEach(el => {
            const char = battlefield[targetSide][el.dataset.index];
            if (char && char.hp > 0) el.classList.add('targetable');
        });
    }

    function resolveAttack(targetSide, targetIndex) {
        if (!pendingAction) return;
        const actor = battlefield[pendingAction.side][pendingAction.index];
        const target = battlefield[targetSide][targetIndex];
        const skill = pendingAction.skill;
        let finalDamage = skill.damage;

        if (actor.statuses.includes("weak")) {
            finalDamage = Math.floor(finalDamage * 0.5);
            actor.statuses = actor.statuses.filter(s => s !== "weak");
        }
        if (skill.type === "enemy_debuff") { target.statuses.push(skill.effect); }
        if (skill.type === "ranger_link") {
            const rangerCount = battlefield[pendingAction.side].filter(u => u && u.tag === "ranger" && u.hp > 0).length;
            finalDamage = 150 * rangerCount;
            globalRangerLinkLimit--; // 【整局次數扣除】
        }
        if (skill.type !== "true_dmg" && target.statuses.includes("dodge")) {
            finalDamage = 0; target.statuses = target.statuses.filter(s => s !== "dodge");
            addLog(`[閃避] ${target.name} 避開攻擊！`);
        }

        target.hp = Math.max(0, target.hp - finalDamage);
        actor.acted = true;
        addLog(`⚔️ ${actor.name} 造成 ${finalDamage} 傷害。`);
        pendingAction = null;
        document.querySelectorAll('.slot').forEach(el => el.classList.remove('targetable'));
        renderBattlefield();
    }

    function nextTurn() {
        currentTurn++;
        document.getElementById('turn-count').innerText = currentTurn;
        ['p1', 'p2'].forEach(side => { battlefield[side].forEach(char => { if (char) char.acted = false; }); });
        addLog(`--- 第 ${currentTurn} 回合 ---`);
        renderBattlefield();
    }

    // 【新增功能】清理對局 / 重置戰場
    function resetBattlefield() {
        if (confirm("確定要清空整場對局嗎？這會移除所有角色並重置回合與技能次數。")) {
            battlefield = { p1: [null, null, null, null, null], p2: [null, null, null, null, null] };
            currentTurn = 1;
            globalRangerLinkLimit = 2; // 重置聯動次數
            document.getElementById('turn-count').innerText = currentTurn;
            document.getElementById('combat-log').innerHTML = "> 戰場已清空。請重新配置角色。";
            renderBattlefield();
        }
    }

    function addLog(msg) {
        const log = document.getElementById('combat-log');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }
</script>
</body>
</html>
