<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©å‹•åŸå¸‚ SPARK - æ•¸ä½å°æˆ°è£åˆ¤å°</title>
    <style>
        :root { 
            --p1-bg: #0d1b2a; --p1-accent: #00acee; 
            --p2-bg: #2b0d0d; --p2-accent: #ff4444; 
            --text-color: #e0e1dd;
        }
        body { 
            background: #000; color: var(--text-color); 
            font-family: "Microsoft JhengHei", sans-serif; 
            margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 2px solid #333; 
        }
        .turn-badge { 
            font-size: 1.5rem; background: #f1c40f; color: #000; 
            padding: 5px 20px; border-radius: 20px; font-weight: bold; 
        }

        /* æˆ°å ´å€åŸŸ */
        .battlefield { 
            display: flex; flex: 1; gap: 10px; margin-top: 10px; overflow: hidden;
        }
        .side { 
            flex: 1; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
        }
        #side-p1 { background: var(--p1-bg); border: 2px solid var(--p1-accent); }
        #side-p2 { background: var(--p2-bg); border: 2px solid var(--p2-accent); }

        /* è§’è‰²å¡ç‰‡ (Slot) */
        .slot { 
            background: rgba(255,255,255,0.05); border: 1px dashed #555; 
            border-radius: 8px; min-height: 100px; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        
        /* ç•¶è§’è‰²å­˜åœ¨æ™‚çš„æ¨£å¼ */
        .char-card { width: 100%; padding: 10px; box-sizing: border-box; }
        .char-header { display: flex; justify-content: space-between; align-items: center; }
        .char-name { font-weight: bold; font-size: 1.1em; color: #fff; }
        
        /* è¡€æ¢ */
        .hp-container { width: 100%; background: #333; height: 10px; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s; }
        
        /* æŠ€èƒ½æŒ‰éˆ•å€ */
        .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .skill-btn { 
            background: #444; color: #fff; border: 1px solid #666; 
            padding: 5px; font-size: 0.8rem; cursor: pointer; border-radius: 4px;
        }
        .skill-btn:hover { background: #666; }

        /* ç‹€æ…‹æ¨£å¼ */
        .slot.acted { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        .slot.targetable { border: 2px solid #f1c40f; box-shadow: 0 0 10px #f1c40f; cursor: crosshair; animation: pulse 1s infinite; }
        .slot.dead { filter: grayscale(1); opacity: 0.3; border-color: #333; }

        /* åŠ å…¥è§’è‰²æŒ‰éˆ• */
        .add-btn { 
            background: transparent; color: #777; border: none; font-size: 2rem; cursor: pointer; 
        }
        .add-interface { width: 90%; display: none; flex-direction: column; gap: 5px; }
        
        /* åº•éƒ¨æ§åˆ¶å€ & Log */
        .control-panel { height: 150px; display: flex; gap: 10px; margin-top: 10px; }
        .log-box { flex: 3; background: #111; border: 1px solid #333; padding: 10px; overflow-y: scroll; font-family: monospace; color: #0f0; font-size: 0.9rem; }
        .main-btn { flex: 1; background: #f1c40f; color: #000; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 5px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div>
        <h2 style="margin:0;">SPARK ç©å‹•åŸå¸‚</h2>
        <small>æ•¸ä½è£åˆ¤ç³»çµ± v2.0</small>
    </div>
    <div class="turn-badge">ç¬¬ <span id="turn-count">1</span> å›åˆ</div>
</header>

<div class="battlefield">
    <div class="side" id="side-p1">
        <h3 style="margin:0; text-align:center; color:var(--p1-accent)">æˆ‘æ–¹éšŠä¼</h3>
        </div>

    <div class="side" id="side-p2">
        <h3 style="margin:0; text-align:center; color:var(--p2-accent)">æ•µæ–¹éšŠä¼</h3>
        </div>
</div>

<div class="control-panel">
    <div class="log-box" id="combat-log">
        > ç³»çµ±å°±ç·’ã€‚<br>
        > è«‹é»æ“Šã€Œ+ã€è™Ÿé…ç½®é›™æ–¹è§’è‰²ã€‚<br>
    </div>
    <button class="main-btn" onclick="nextTurn()">çµæŸå›åˆ<br>Next Turn</button>
</div>

<datalist id="char-list-data"></datalist>

<script>
    // ==========================================
    // 1. è§’è‰²å¤§æ•¸æ“šåº« (åœ¨é€™è£¡æ–°å¢ä½ çš„è§’è‰²ï¼)
    // ==========================================
    const characterDatabase = [
        {
            id: "ranger_blue",
            name: "è‹±åœ‹éŠé¨å…µ",
            hp: 500,
            skills: [
                { name: "ç²¾æº–å°„æ“Š", damage: 100, type: "true_dmg", desc: "çœŸå¯¦å‚·å®³" },
                { name: "æ§æ—å½ˆé›¨", damage: 150, type: "aoe_trigger", desc: "è§¸ç™¼é€£å‹•" },
                { name: "ç–¾é¢¨æ­¥ä¼", damage: 0, type: "buff", desc: "é–ƒé¿ç‹€æ…‹" }
            ]
        },
        {
            id: "wei_yan",
            name: "é­å»¶ (åé£Ÿå¤©åœ°)",
            hp: 1000,
            skills: [
                { name: "æ–¬æœˆé–ƒ", damage: 150, type: "physical", desc: "å¼·åŠ›æ–¬æ“Š" },
                { name: "ç‹‚æš´", damage: 0, type: "buff", desc: "æ”»æ“ŠåŠ›æå‡" }
            ]
        },
        {
            id: "guan_yu",
            name: "é—œç¾½",
            hp: 1200,
            skills: [
                { name: "é’é¾åƒæœˆ", damage: 200, type: "physical", desc: "é«˜é¡å‚·å®³" },
                { name: "æ­¦è–å¨åš´", damage: 0, type: "debuff", desc: "æ•µæ–¹é™æ”»" }
            ]
        },
        {
            id: "soldier_a",
            name: "ä¸€èˆ¬å°å…µ",
            hp: 200,
            skills: [
                { name: "çªåˆº", damage: 50, type: "physical", desc: "æ™®é€šæ”»æ“Š" }
            ]
        }
    ];

    // ==========================================
    // 2. ç³»çµ±æ ¸å¿ƒé‚è¼¯
    // ==========================================
    
    // åˆå§‹åŒ–æˆ°å ´ç‹€æ…‹ (5å°5)
    let battlefield = {
        p1: [null, null, null, null, null], // æˆ‘æ–¹ 5 æ ¼
        p2: [null, null, null, null, null]  // æ•µæ–¹ 5 æ ¼
    };
    
    let currentTurn = 1;
    let pendingAction = null; // æš«å­˜ç›®å‰çš„æ”»æ“ŠæŒ‡ä»¤ { attackerSide, attackerIndex, skill }

    // åˆå§‹åŒ–ï¼šç”Ÿæˆä¸‹æ‹‰é¸å–®è³‡æ–™ èˆ‡ æˆ°å ´æ ¼å­
    window.onload = function() {
        initDatalist();
        renderBattlefield();
    };

    function initDatalist() {
        const list = document.getElementById('char-list-data');
        characterDatabase.forEach(char => {
            const option = document.createElement('option');
            option.value = char.name; // æœå°‹æ™‚é¡¯ç¤ºçš„æ–‡å­—
            list.appendChild(option);
        });
    }

    // æ¸²æŸ“æˆ°å ´ (æ ¸å¿ƒåŠŸèƒ½)
    function renderBattlefield() {
        renderSide('p1', document.getElementById('side-p1'));
        renderSide('p2', document.getElementById('side-p2'));
    }

    function renderSide(sideKey, container) {
        // ä¿ç•™æ¨™é¡Œï¼Œæ¸…ç©ºå…§å®¹
        const title = container.querySelector('h3');
        container.innerHTML = '';
        container.appendChild(title);

        battlefield[sideKey].forEach((char, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = `slot`;
            slotDiv.dataset.side = sideKey;
            slotDiv.dataset.index = index;

            // 1. å¦‚æœæ ¼å­æ˜¯ç©ºçš„ -> é¡¯ç¤ºåŠ å…¥æŒ‰éˆ•
            if (!char) {
                slotDiv.innerHTML = `
                    <button class="add-btn" onclick="toggleAddMenu('${sideKey}', ${index})">+</button>
                    <div class="add-interface" id="add-menu-${sideKey}-${index}">
                        <input list="char-list-data" placeholder="è¼¸å…¥è§’è‰²åç¨±..." id="input-${sideKey}-${index}">
                        <button onclick="addCharacter('${sideKey}', ${index})">ç¢ºèª</button>
                    </div>
                `;
            } 
            // 2. å¦‚æœæ ¼å­æœ‰è§’è‰²
            else {
                if (char.hp <= 0) slotDiv.classList.add('dead');
                if (char.acted) slotDiv.classList.add('acted');
                
                const hpPercent = (char.hp / char.maxHp) * 100;
                
                let skillsHtml = '';
                char.skills.forEach((skill, sIdx) => {
                    skillsHtml += `<button class="skill-btn" onclick="selectSkill('${sideKey}', ${index}, ${sIdx})">${skill.name}</button>`;
                });

                slotDiv.innerHTML = `
                    <div class="char-card">
                        <div class="char-header">
                            <span class="char-name">${char.name}</span>
                            <small onclick="removeChar('${sideKey}', ${index})" style="cursor:pointer;color:#555">âŒ</small>
                        </div>
                        <div class="hp-container">
                            <div class="hp-fill" style="width: ${hpPercent}%"></div>
                        </div>
                        <small>HP: ${char.hp} / ${char.maxHp}</small>
                        <div class="skill-list">${skillsHtml}</div>
                    </div>
                `;

                // ç¶å®šã€Œè¢«æ”»æ“Šã€çš„é»æ“Šäº‹ä»¶ (å¦‚æœæ­£åœ¨é¸ç›®æ¨™)
                slotDiv.onclick = function(e) {
                    // é˜²æ­¢é»æ“ŠæŠ€èƒ½æŒ‰éˆ•æ™‚è§¸ç™¼
                    if(e.target.tagName === 'BUTTON') return;
                    if(pendingAction && slotDiv.classList.contains('targetable')) {
                        resolveAttack(sideKey, index);
                    }
                }
            }
            container.appendChild(slotDiv);
        });
    }

    // ==========================================
    // 3. è§’è‰²ç®¡ç† (æ–°å¢/åˆªé™¤)
    // ==========================================

    function toggleAddMenu(side, index) {
        const menu = document.getElementById(`add-menu-${side}-${index}`);
        menu.style.display = 'flex';
        menu.querySelector('input').focus();
    }

    function addCharacter(side, index) {
        const inputVal = document.getElementById(`input-${side}-${index}`).value;
        // å¾è³‡æ–™åº«æ‰¾è§’è‰²
        const template = characterDatabase.find(c => c.name === inputVal);
        
        if (!template) {
            alert("æ‰¾ä¸åˆ°è©²è§’è‰²ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æˆ–åç¨±ï¼");
            return;
        }

        // è¤‡è£½ä¸€ä»½æ–°çš„è§’è‰²ç‰©ä»¶ (Deep Copy)ï¼Œé¿å…äº’ç›¸å½±éŸ¿
        battlefield[side][index] = JSON.parse(JSON.stringify(template));
        battlefield[side][index].maxHp = template.hp; // è¨­å®šæœ€å¤§è¡€é‡
        battlefield[side][index].acted = false; // åˆå§‹åŒ–è¡Œå‹•ç‹€æ…‹

        addLog(`[ç³»çµ±] ${template.name} åŠ å…¥äº†æˆ°å ´ (ä½ç½®: ${side}-${index+1})`);
        renderBattlefield();
    }

    function removeChar(side, index) {
        if(confirm("ç¢ºå®šè¦ç§»é™¤é€™éš»è§’è‰²å—ï¼Ÿ")) {
            battlefield[side][index] = null;
            renderBattlefield();
        }
    }

    // ==========================================
    // 4. æˆ°é¬¥æ ¸å¿ƒï¼šæŠ€èƒ½èˆ‡æŒ‡å®šæ”»æ“Š
    // ==========================================

    function selectSkill(side, index, skillIndex) {
        const actor = battlefield[side][index];
        const skill = actor.skills[skillIndex];

        if (actor.hp <= 0) return alert("è©²è§’è‰²å·²é™£äº¡");
        if (actor.acted) return alert("æœ¬å›åˆå·²è¡Œå‹•é");

        // è¨­å®šæš«å­˜å‹•ä½œ
        pendingAction = {
            side: side,
            index: index,
            skill: skill,
            actorName: actor.name
        };

        addLog(`[æº–å‚™] ${actor.name} æº–å‚™ä½¿ç”¨ ã€${skill.name}ã€‘ï¼Œè«‹é»é¸ç›®æ¨™ï¼`);

        // é«˜äº®é¡¯ç¤ºæ‰€æœ‰åˆæ³•çš„æ•µæ–¹ç›®æ¨™
        const enemySide = (side === 'p1') ? 'p2' : 'p1';
        highlightTargets(enemySide);
    }

    function highlightTargets(targetSide) {
        // ç§»é™¤èˆŠçš„é«˜äº®
        document.querySelectorAll('.slot').forEach(el => el.classList.remove('targetable'));

        // æ‰¾å‡ºæ‰€æœ‰æ´»è‘—çš„æ•µæ–¹æ ¼å­
        document.querySelectorAll(`.slot[data-side="${targetSide}"]`).forEach(el => {
            const idx = el.dataset.index;
            const char = battlefield[targetSide][idx];
            if (char && char.hp > 0) {
                el.classList.add('targetable');
            }
        });
    }

    function resolveAttack(targetSide, targetIndex) {
        if (!pendingAction) return;

        const target = battlefield[targetSide][targetIndex];
        const skill = pendingAction.skill;
        const damage = skill.damage;

        // 1. æ‰£è¡€é‚è¼¯
        target.hp -= damage;
        if (target.hp < 0) target.hp = 0;

        // 2. æ¨™è¨˜ç™¼å‹•è€…ç‚ºã€Œå·²è¡Œå‹•ã€
        battlefield[pendingAction.side][pendingAction.index].acted = true;

        // 3. ç´€éŒ„ Log
        addLog(`âš”ï¸ ${pendingAction.actorName} å° ${target.name} ä½¿ç”¨äº†ã€${skill.name}ã€‘ï¼`);
        addLog(`ğŸ’¥ é€ æˆ ${damage} é»å‚·å®³ã€‚ ${target.name} å‰©é¤˜ HP: ${target.hp}`);

        if (target.hp === 0) {
            addLog(`ğŸ’€ ${target.name} å€’ä¸‹äº†ï¼`);
        }

        // 4. æ¸…é™¤æš«å­˜èˆ‡é«˜äº®
        pendingAction = null;
        document.querySelectorAll('.slot').forEach(el => el.classList.remove('targetable'));
        
        // 5. é‡æ–°æ¸²æŸ“ç•«é¢
        renderBattlefield();
    }

    // ==========================================
    // 5. å›åˆç®¡ç†
    // ==========================================
    function nextTurn() {
        currentTurn++;
        document.getElementById('turn-count').innerText = currentTurn;
        
        // é‡ç½®é›™æ–¹æ‰€æœ‰äººçš„ acted ç‹€æ…‹
        ['p1', 'p2'].forEach(side => {
            battlefield[side].forEach(char => {
                if (char) char.acted = false;
            });
        });

        addLog(`--- ç¬¬ ${currentTurn} å›åˆé–‹å§‹ ---`);
        
        // æ¸…é™¤ä»»ä½•æœªå®Œæˆçš„é¸å–ç‹€æ…‹
        pendingAction = null;
        document.querySelectorAll('.slot').forEach(el => el.classList.remove('targetable'));
        
        renderBattlefield();
    }

    function addLog(msg) {
        const log = document.getElementById('combat-log');
        const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
        log.innerHTML = `<span>[${time}] ${msg}</span><br>` + log.innerHTML;
    }

</script>

</body>
</html>
