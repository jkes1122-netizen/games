<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>積動城市 SPARK - 數位裁判系統 v2.3</title>
    <style>
        :root { --p1-bg: #0d1b2a; --p1-accent: #00acee; --p2-bg: #2b0d0d; --p2-accent: #ff4444; --text-color: #e0e1dd; }
        body { background: #000; color: var(--text-color); font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 2px solid #333; }
        .turn-badge { font-size: 1.5rem; background: #f1c40f; color: #000; padding: 5px 20px; border-radius: 20px; font-weight: bold; }
        .battlefield { display: flex; flex: 1; gap: 10px; margin-top: 10px; overflow: hidden; }
        .side { flex: 1; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        #side-p1 { background: var(--p1-bg); border: 2px solid var(--p1-accent); }
        #side-p2 { background: var(--p2-bg); border: 2px solid var(--p2-accent); }
        .slot { background: rgba(255,255,255,0.05); border: 1px dashed #555; border-radius: 8px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .char-card { width: 100%; padding: 10px; box-sizing: border-box; }
        .char-name { font-weight: bold; font-size: 1.1em; color: #fff; }
        .status-tag { background: #e67e22; color: #fff; font-size: 0.7rem; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .status-tag.weak { background: #9b59b6; } /* 虛弱狀態用紫色 */
        .hp-container { width: 100%; background: #333; height: 10px; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s; }
        .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .skill-btn { background: #444; color: #fff; border: 1px solid #666; padding: 5px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .skill-btn:hover { background: #666; }
        .slot.acted { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        .slot.targetable { border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; cursor: crosshair; animation: pulse 0.8s infinite; }
        .slot.dead { filter: grayscale(1); opacity: 0.3; }
        .control-panel { height: 150px; display: flex; gap: 10px; margin-top: 10px; }
        .log-box { flex: 3; background: #111; border: 1px solid #333; padding: 10px; overflow-y: scroll; font-family: monospace; color: #0f0; font-size: 0.9rem; }
        .main-btn { flex: 1; background: #f1c40f; color: #000; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .add-btn { background: transparent; color: #777; border: none; font-size: 2rem; cursor: pointer; }
        .add-interface { width: 90%; display: none; flex-direction: column; gap: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<header>
    <div><h2 style="margin:0;">SPARK 積動城市</h2><small>數位裁判台 v2.3 (三國武將錄入)</small></div>
    <div style="text-align: right">
        <div class="turn-badge">第 <span id="turn-count">1</span> 回合</div>
        <div id="link-count-display" style="color: #00acee; font-size: 0.8rem; margin-top: 5px;">本回合遊騎兵連動次數：0 / 2</div>
    </div>
</header>

<div class="battlefield">
    <div class="side" id="side-p1"><h3 style="margin:0; text-align:center; color:var(--p1-accent)">我方隊伍</h3></div>
    <div class="side" id="side-p2"><h3 style="margin:0; text-align:center; color:var(--p2-accent)">敵方隊伍</h3></div>
</div>

<div class="control-panel">
    <div class="log-box" id="combat-log">> 系統就緒。</div>
    <button class="main-btn" onclick="nextTurn()">結束回合<br>Next Turn</button>
</div>

<datalist id="char-list-data"></datalist>

<script>
    // 1. 角色大數據庫
    const characterDatabase = [
        {
            id: "ranger", name: "英國遊騎兵", hp: 500, tag: "ranger",
            skills: [
                { name: "精準射擊", damage: 100, type: "true_dmg" },
                { name: "槍林彈雨", damage: 150, type: "ranger_link" },
                { name: "疾風步伐", damage: 0, type: "self_buff", effect: "dodge" }
            ]
        },
        {
            id: "guan_yu", name: "關羽", hp: 1200, tag: "general",
            skills: [
                { name: "青龍偃月", damage: 200, type: "physical" },
                { name: "武聖威嚴", damage: 0, type: "enemy_debuff", effect: "weak" }
            ]
        },
        {
            id: "wei_yan", name: "魏延", hp: 1000, tag: "general",
            skills: [{ name: "斬月閃", damage: 150, type: "physical" }]
        },
        {
            id: "soldier_a", name: "一般小兵", hp: 200, tag: "mob",
            skills: [{ name: "突刺", damage: 50, type: "physical" }]
        }
    ];

    let battlefield = { p1: [null, null, null, null, null], p2: [null, null, null, null, null] };
    let currentTurn = 1;
    let pendingAction = null;
    let rangerLinkUsedCount = 0;

    window.onload = function() { initDatalist(); renderBattlefield(); };

    function initDatalist() {
        const list = document.getElementById('char-list-data');
        characterDatabase.forEach(char => {
            const option = document.createElement('option');
            option.value = char.name;
            list.appendChild(option);
        });
    }

    function renderBattlefield() {
        renderSide('p1', document.getElementById('side-p1'));
        renderSide('p2', document.getElementById('side-p2'));
        document.getElementById('link-count-display').innerText = `本回合遊騎兵聯動次數：${rangerLinkUsedCount} / 2`;
    }

    function renderSide(sideKey, container) {
        const title = container.querySelector('h3');
        container.innerHTML = '';
        container.appendChild(title);
        battlefield[sideKey].forEach((char, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = `slot`;
            slotDiv.dataset.side = sideKey;
            slotDiv.dataset.index = index;
            if (!char) {
                slotDiv.innerHTML = `<button class="add-btn" onclick="toggleAddMenu('${sideKey}', ${index})">+</button><div class="add-interface" id="add-menu-${sideKey}-${index}"><input list="char-list-data" placeholder="角色..." id="input-${sideKey}-${index}"><button onclick="addCharacter('${sideKey}', ${index})">OK</button></div>`;
            } else {
                if (char.hp <= 0) slotDiv.classList.add('dead');
                if (char.acted) slotDiv.classList.add('acted');
                const hpPercent = (char.hp / char.maxHp) * 100;
                let statusHtml = char.statuses.map(s => `<span class="status-tag ${s}">${s === 'weak' ? '虛弱' : s}</span>`).join('');
                let skillsHtml = char.skills.map((s, sIdx) => `<button class="skill-btn" onclick="selectSkill('${sideKey}', ${index}, ${sIdx})">${s.name}</button>`).join('');
                slotDiv.innerHTML = `<div class="char-card"><div class="char-header"><span class="char-name">${char.name}${statusHtml}</span><small onclick="removeChar('${sideKey}', ${index})" style="cursor:pointer">❌</small></div><div class="hp-container"><div class="hp-fill" style="width: ${hpPercent}%"></div></div><small>HP: ${char.hp}/${char.maxHp}</small><div class="skill-list">${skillsHtml}</div></div>`;
                slotDiv.onclick = function(e) { if(e.target.tagName !== 'BUTTON' && pendingAction && slotDiv.classList.contains('targetable')) resolveAttack(sideKey, index); }
            }
            container.appendChild(slotDiv);
        });
    }

    function toggleAddMenu(side, index) { document.getElementById(`add-menu-${side}-${index}`).style.display = 'flex'; }
    function addCharacter(side, index) {
        const inputVal = document.getElementById(`input-${side}-${index}`).value;
        const template = characterDatabase.find(c => c.name === inputVal);
        if (!template) return;
        battlefield[side][index] = JSON.parse(JSON.stringify(template));
        battlefield[side][index].maxHp = template.hp; battlefield[side][index].acted = false; battlefield[side][index].statuses = [];
        renderBattlefield();
    }
    function removeChar(side, index) { battlefield[side][index] = null; renderBattlefield(); }

    function selectSkill(side, index, skillIndex) {
        const actor = battlefield[side][index];
        const skill = actor.skills[skillIndex];
        if (actor.hp <= 0 || actor.acted) return;

        if (skill.type === "ranger_link" && rangerLinkUsedCount >= 2) {
            addLog(`⚠️ 聯動次數已達上限！`); return;
        }

        if (skill.type === 'self_buff') {
            actor.statuses.push(skill.effect); actor.acted = true;
            addLog(`[技能] ${actor.name} 使用了 【${skill.name}】！`);
            renderBattlefield(); return;
        }

        pendingAction = { side, index, skill, actorName: actor.name };
        addLog(`[準備] ${actor.name} 發動 ${skill.name}，請點選目標。`);
        highlightTargets(side === 'p1' ? 'p2' : 'p1');
    }

    function highlightTargets(targetSide) {
        document.querySelectorAll(`.slot[data-side="${targetSide}"]`).forEach(el => {
            const char = battlefield[targetSide][el.dataset.index];
            if (char && char.hp > 0) el.classList.add('targetable');
        });
    }

    function resolveAttack(targetSide, targetIndex) {
        if (!pendingAction) return;
        const actor = battlefield[pendingAction.side][pendingAction.index];
        const target = battlefield[targetSide][targetIndex];
        const skill = pendingAction.skill;
        
        let finalDamage = skill.damage;

        // 【邏輯 1】虛弱判定：若攻擊者處於 weak 狀態，傷害減半
        if (actor.statuses.includes("weak")) {
            finalDamage = Math.floor(finalDamage * 0.5);
            addLog(`[虛弱] ${actor.name} 力量衰減，傷害減半！`);
            // 攻擊後移除虛弱狀態 (消耗型 debuff)
            actor.statuses = actor.statuses.filter(s => s !== "weak");
        }

        // 【邏輯 2】Debuff 施放邏輯：如武聖威嚴
        if (skill.type === "enemy_debuff") {
            target.statuses.push(skill.effect);
            addLog(`[效果] ${target.name} 受 ${skill.name} 影響，進入 ${skill.effect} 狀態！`);
        }

        // 【邏輯 3】遊騎兵連動
        if (skill.type === "ranger_link") {
            const rangerCount = battlefield[pendingAction.side].filter(u => u && u.tag === "ranger" && u.hp > 0).length;
            finalDamage = 150 * rangerCount;
            rangerLinkUsedCount++;
        }

        // 【邏輯 4】閃避判定
        if (skill.type !== "true_dmg" && target.statuses.includes("dodge")) {
            finalDamage = 0; target.statuses = target.statuses.filter(s => s !== "dodge");
            addLog(`[閃避] ${target.name} 避開攻擊！`);
        }

        target.hp = Math.max(0, target.hp - finalDamage);
        actor.acted = true;
        if(finalDamage > 0) addLog(`⚔️ ${actor.name} 對 ${target.name} 造成 ${finalDamage} 傷害。`);
        
        pendingAction = null;
        document.querySelectorAll('.slot').forEach(el => el.classList.remove('targetable'));
        renderBattlefield();
    }

    function nextTurn() {
        currentTurn++; rangerLinkUsedCount = 0;
        document.getElementById('turn-count').innerText = currentTurn;
        ['p1', 'p2'].forEach(side => { battlefield[side].forEach(char => { if (char) char.acted = false; }); });
        addLog(`--- 第 ${currentTurn} 回合 ---`);
        renderBattlefield();
    }

    function addLog(msg) {
        const log = document.getElementById('combat-log');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }
</script>
</body>
</html>
